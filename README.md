# Инструкция по развертыванию приложения

## Установка

* Клонируем репозиторий командой `git clone https://github.com/JavNikTool/skillaApi`
* Переходим в директорию с проектом
* Устанавливаем зависимости `composer install`
* Копируем `.env.example` в `.env`
* Создаем ключ для приложения `php artisan key:generate`
* Создаем базу данных 'database.sqlite' в директории `/database`
* Создаем базу данных 'database-test.sqlite' в директории `/database`, она нам пригодится для тестов
* Запускаем миграции `php artisan migrate`
* Запускаем сидеры `php artisan db:seed`
* Запускаем сервер `php artisan serve`

## Настройка laravel passport

* Устанавливаем passport командой `php artisan install:api --passport`
* После установки, нам предложат использовать UUID вместо ID для клиентов, оставляем на свое усмотрение
* Генерируем ключи шифрования `php artisan passport:keys`
* Далее нам необходимо создать клиента для выпуска токенов персонального доступа, делаем это командой `php artisan passport:client --personal`
* После введения команды в консоли, нам предложат указать имя для клиента, выбираем любое.
* После создания клиента мы получим в терминал его ID и секрет, которые нам нужно заполнить в файле `.env` в секции `PASSPORT_PERSONAL_ACCESS_CLIENT_ID` и `PASSPORT_PERSONAL_ACCESS_CLIENT_SECRET`

## Настройка laravel reverb

* Необходимо убедиться, что порт, указанный в REVERB_PORT в файле `.env` доступен, в противном случае указать доступный порт
* Запускаем вэбсокет-сервер `php artisan reverb:serve`

## Проверка работы вэбсокет-сервера

* Т.к в приложении нет никакой клиентской части, проверить работу вэбсокет-сервера можно в postman, либо в другом удобном для вас способе, дальше будет инструкция именно для postman
* В программе Postman создаем новый реквест, выбираем ему тип WebSocket
* В поле Host указываем адрес вэбсокет-сервера `ws://{host}:{post}/app/{app_key}`. `app_key` берем из .env файла, REVERB_APP_KEY
* Нажимаем `Connect` - подключаемся к вэбсокет-серверу
* Далее нам нужно получить токен персонального доступа для исполнителя, для этого используем маршрут `POST http://{host}:{port}/api/v1/worker/login`
* Далее, т.к все события работают по приватным каналам, нам нужно получить токен аутентификации нужного канала, для этого используем маршрут `POST http://{host}:{port}/api/v1/broadcasting/auth`, где мы указываем в тело запрос `channel_id` и `socket_id`
* `channel_id` имеет следующий шаблон `private-worker.{worker_id}`, где `worker_id` id того исполнителя, под которым мы аутентифицированы.
* `socket_id` берем из ответа маршрута `POST http://{host}:{port}/api/v1/broadcasting/auth`
* В случае успешного запроса мы получаем токен аутентификации приватного канала в виде строки
* Далее возвращаемся в Postman, в поле Body выбираем тип raw, в поле raw выбираем JSON, в поле JSON вставляем следующий JSON:
```json
{
    "event": "pusher:subscribe",
    "data": {
        "channel": "private-worker.{worker_id}",
        "auth": "{token}"
    }
}
```
В поле `worker_id` вставляем id исполнителя, которому мы аутентифицированы \
В поле `token` вставляем токен аутентификации приватного канала
* Теперь мы подписаны на события для данного исполнителя

## Документация маршрутов

* Документация маршрутов доступна по адресу `http://{host}:{port}/docs/api`, при условии, что у вас запущена команда `php artisan serve`

## Тестирование

* Запускаем тесты `php artisan test`

# Благодарю за внимание!

